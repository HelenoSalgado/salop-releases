name: Build Linux App

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        repository: Instituto-Reformado-Santo-Evangelho/bereia-verse
        token: ${{ secrets.GH_PAT_BEREIA }}
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Inject Google Client Secrets
      env:
        GOOGLE_SECRETS: ${{ secrets.GOOGLE_CLIENT_SECRETS }}
      run: echo "$GOOGLE_SECRETS" > composeApp/src/jvmMain/resources/client_secrets.json

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fakeroot binutils

    - name: Build Linux DEB
      run: ./gradlew :composeApp:createDistributable :composeApp:packageDeb --no-configuration-cache

    # === INÍCIO EMPACOTAMENTO ARCH ===
    - name: Checkout Release Repo (PKGBUILD)
      uses: actions/checkout@v4
      with:
        path: release_repo

    - name: Prepare Arch Build
      run: |
        TAG=${{ github.ref_name }}
        VERSION=${TAG#v}
        if [[ -z "$VERSION" ]] || [[ "$VERSION" == "main" ]]; then VERSION="0.0.0"; fi
        
        echo "Preparing Arch build for version: $VERSION"
        mkdir -p build_arch
        
        # Copiar PKGBUILD e .desktop
        cp release_repo/arch/PKGBUILD build_arch/
        cp release_repo/arch/BereiaVerse.desktop build_arch/
        
        # Atualizar versão no PKGBUILD
        sed -i "s/pkgver=0.0.0/pkgver=$VERSION/" build_arch/PKGBUILD
        
        # Copiar Binários do App (Do output do Gradle)
        # O caminho exato do Compose Desktop é app/<nome-do-app>
        cp -r composeApp/build/compose/binaries/main/app/bereia-verse/* build_arch/app/
        
        # Tentar encontrar e copiar o ícone PNG
        # O Compose costuma colocar recursos processados aqui:
        ICON_PATH=$(find composeApp/build/compose/binaries/main -name "*.png" | head -n 1)
        if [ -n "$ICON_PATH" ]; then
            echo "Icon found at: $ICON_PATH"
            cp "$ICON_PATH" build_arch/bereia-verse.png
        else
            echo "WARNING: No PNG icon found. The package will lack an icon."
        fi

    - name: Build Arch Package (Docker)
      uses: addnab/docker-run-action@v3
      with:
        image: archlinux:latest
        options: -v ${{ github.workspace }}/build_arch:/package
        run: |
          # Instalar dependências básicas de build e runtime do app
          pacman -Syu --noconfirm --needed base-devel
          
          # Criar usuário builder (makepkg não pode rodar como root)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder /package
          
          # Rodar makepkg
          # --noconfirm para o pacman interno e enviando '1' para o prompt de provedor java
          su builder -c "cd /package && yes 1 | makepkg -s --noconfirm"
    # === FIM EMPACOTAMENTO ARCH ===

    - name: Upload DEB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: verse-linux-deb
        path: composeApp/build/compose/binaries/main/deb/*.deb

    - name: Upload Arch Artifact
      uses: actions/upload-artifact@v4
      with:
        name: verse-arch-pkg
        path: build_arch/*.pkg.tar.zst

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          composeApp/build/compose/binaries/main/deb/*.deb
          build_arch/*.pkg.tar.zst
